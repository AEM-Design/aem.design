I"[K<aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#development-tools" id="markdown-toc-development-tools">Development Tools</a>    <ul>
      <li><a href="#git" id="markdown-toc-git">Git</a></li>
      <li><a href="#apache-maven" id="markdown-toc-apache-maven">Apache Maven</a>        <ul>
          <li><a href="#package-build" id="markdown-toc-package-build">Package Build</a>            <ul>
              <li><a href="#local-development-build" id="markdown-toc-local-development-build">Local Development Build</a></li>
              <li><a href="#local-development-service-module-build" id="markdown-toc-local-development-service-module-build">Local Development Service Module Build</a></li>
              <li><a href="#local-development-common-module-build" id="markdown-toc-local-development-common-module-build">Local Development Common Module Build</a></li>
              <li><a href="#local-development-config-module-build" id="markdown-toc-local-development-config-module-build">Local Development Config Module Build</a></li>
              <li><a href="#local-development-content-module-build" id="markdown-toc-local-development-content-module-build">Local Development Content Module Build</a></li>
              <li><a href="#full-build-and-deploy-to-repository" id="markdown-toc-full-build-and-deploy-to-repository">Full Build and Deploy to Repository</a></li>
            </ul>
          </li>
          <li><a href="#jgitflow-plugin" id="markdown-toc-jgitflow-plugin">JGitFlow Plugin</a>            <ul>
              <li><a href="#plugin-usage" id="markdown-toc-plugin-usage">Plugin Usage</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#ansible-playbooks" id="markdown-toc-ansible-playbooks">Ansible Playbooks</a>        <ul>
          <li><a href="#site-playbooks" id="markdown-toc-site-playbooks">Site Playbooks</a>            <ul>
              <li><a href="#siteyml" id="markdown-toc-siteyml">site.yml</a></li>
              <li><a href="#site-teardownyml" id="markdown-toc-site-teardownyml">site-teardown.yml</a></li>
              <li><a href="#site-devopsyml" id="markdown-toc-site-devopsyml">site-devops.yml</a></li>
            </ul>
          </li>
          <li><a href="#operations-playbooks" id="markdown-toc-operations-playbooks">Operations Playbooks</a>            <ul>
              <li><a href="#operation-aem-deployyml" id="markdown-toc-operation-aem-deployyml">operation-aem-deploy.yml</a></li>
              <li><a href="#operation-esb-deployyml" id="markdown-toc-operation-esb-deployyml">operation-esb-deploy.yml</a></li>
              <li><a href="#operation-oak-compactionyml" id="markdown-toc-operation-oak-compactionyml">operation-oak-compaction.yml</a></li>
              <li><a href="#operation-volume-fstrimyml" id="markdown-toc-operation-volume-fstrimyml">operation-volume-fstrim.yml</a></li>
            </ul>
          </li>
          <li><a href="#group-playbooks" id="markdown-toc-group-playbooks">Group Playbooks</a>            <ul>
              <li><a href="#server-playbooks" id="markdown-toc-server-playbooks">Server Playbooks</a></li>
              <li><a href="#application-playbooks" id="markdown-toc-application-playbooks">Application Playbooks</a></li>
            </ul>
          </li>
          <li><a href="#management-playbooks" id="markdown-toc-management-playbooks">Management Playbooks</a></li>
          <li><a href="#libraries" id="markdown-toc-libraries">Libraries</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

  </nav>
</aside>

<h1 id="development-tools">Development Tools</h1>

<h2 id="git">Git</h2>

<p>The projects sources are managed with Git.</p>

<h2 id="apache-maven">Apache Maven</h2>

<p>Maven manages the build lifecycle for the AEM content packages, service bundles and configurations, as well their dependencies. Maven 3.5.0 was used during the development of the project.</p>

<p>The content package projects uses ‘content-package-maven-plugin’ to create a CRX content package.</p>

<p>The project was originally created using the ‘CQ Project Maven Archetype’ (<a href="http://www.cqblueprints.com/setup/maven.html">http://www.cqblueprints.com/setup/maven.html</a>).</p>

<p>The AEM project contains 4 child modules:</p>

<ol>
  <li>
    <p>aemdesign-aem-common</p>

    <ol>
      <li>Embeds aemdesign-aem-services under /apps/aemdesign/install</li>
    </ol>
  </li>
  <li>
    <p>aemdesign-aem-services</p>
  </li>
  <li>
    <p>aemdesign-aem-config</p>

    <ol>
      <li>Creates a configuration package per environment</li>
    </ol>
  </li>
  <li>
    <p>aemdesign-aem-content</p>
  </li>
</ol>

<h3 id="package-build">Package Build</h3>

<p>Maven commands when run in the aemdesign-aem project.</p>

<h4 id="local-development-build">Local Development Build</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn <span class="nt">-PautoInstallPackage</span> clean package
</code></pre></div></div>

<h4 id="local-development-service-module-build">Local Development Service Module Build</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn <span class="nt">-pl</span> services clean package
</code></pre></div></div>

<h4 id="local-development-common-module-build">Local Development Common Module Build</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn <span class="nt">-pl</span> common clean package
</code></pre></div></div>

<p>Note: this embeds the last built service module. To ensure the latest build, use -pl services,common in the command parameters and the order of the modules is important.</p>

<h4 id="local-development-config-module-build">Local Development Config Module Build</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn <span class="nt">-pl</span> config clean package
</code></pre></div></div>

<h4 id="local-development-content-module-build">Local Development Content Module Build</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn <span class="nt">-pl</span> content clean package
</code></pre></div></div>

<h4 id="full-build-and-deploy-to-repository">Full Build and Deploy to Repository</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean deploy
</code></pre></div></div>

<h3 id="jgitflow-plugin">JGitFlow Plugin</h3>

<p>The JGitFlow Maven Goals manages the Git Flow branching strategy.  The table below lists common usages of the JGitFlow. All commands are run in the ‘aemdesign-aem-dam’ parent module.</p>

<table>
  <thead>
    <tr>
      <th>Maven Goals</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>mvn jgitflow:feature-start</td>
      <td>Creates and checks out the new feature branch from /develop</td>
    </tr>
    <tr>
      <td>mvn jgitflow:feature-finish</td>
      <td>Merges the current working feature branch into /develop and deletes the feature branch</td>
    </tr>
    <tr>
      <td>mvn jgitflow:release-start</td>
      <td>Creates a new /release/[build_version] branch from /develop</td>
    </tr>
    <tr>
      <td>mvn jgitflow:release-finish</td>
      <td>Creates a tag named version/[build_version] from /release/[build_version] and merges /release/[build_version] back into /develop and /master. Finally, JGitFlow deletes /release/[build_version]. This ensures that there is only one release in any point in time</td>
    </tr>
    <tr>
      <td>mvn jgitflow:hotfix-start</td>
      <td>Creates a new /hotfix/[build_version] branch from /master</td>
    </tr>
    <tr>
      <td>mvn jgitflow:hotfix-finish</td>
      <td>Creates a tag named version/[build_version] from /hotfix/[build_version] and merges /hotfix/[build_version] back into /develop and /master. Finally, JGitFlow deletes /hotfix/[build_version]</td>
    </tr>
  </tbody>
</table>

<h4 id="plugin-usage">Plugin Usage</h4>

<p>Branching is not be intended to be limited to the JGitFlow Maven Goals. Its underlying actions are standard Git commands and as such they can be repeated with the git command line tool. Also, there are cases where the git command line tool is required. One such case is when a new feature is required in the current release, in which case the feature is branched from <em>/release/[build_version]</em> and not <em>/develop</em>. Another case is resolving conflicts during branch merging.</p>

<p>For details on Git Flow, see the Processes section on <a href="#heading=h.9cjexa5yq6qn">Git Flow</a></p>

<p>For additional details on the plugin <a href="https://bitbucket.org/atlassian/jgit-flow/wiki/Home">https://bitbucket.org/atlassian/jgit-flow/wiki/Home</a>.</p>

<h2 id="ansible-playbooks">Ansible Playbooks</h2>

<p>There are three types of playbooks that perform automated tasks; operation playbooks, group playbooks and site playbooks. A group playbook provisions servers and applications while a site playbook provisions an entire platform. The site playbook will typically run a few group playbooks which will form the platform. Operation playbooks performs regular tasks on groups such as repository maintenance and package deployments.</p>

<p>By convention, the group playbooks are named after the group vars and site playbooks are prefixed with ‘site-’.</p>

<h3 id="site-playbooks">Site Playbooks</h3>

<h4 id="siteyml">site.yml</h4>

<p>The site playbook manages the AEM platform and its testing environments with the use of inventories.</p>

<p>The following playbook command will provision a complete site using the local development inventory,</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./devops accesslocal
</code></pre></div></div>

<p>or:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook <span class="nt">-i</span> inventory/localdev site.yml <span class="nt">--user</span> aemdesign <span class="nt">--private-key</span> ../aemdesign-vm/keys/current/aemdesign
</code></pre></div></div>

<p>A well designed playbook should perform all tasks required to provision a site in a single command. However, there are scenarios where only a part of the playbook is required. It is possible to activate a subset of tasks by running a playbook with tags. For example, by adding the –tags parameter to the ansible-playbook command.</p>

<p>The following are tags that are in use:</p>

<ul>
  <li>
    <p>docker-host-stop-containers</p>
  </li>
  <li>
    <p>docker-host-stopped</p>
  </li>
  <li>
    <p>docker-images-build</p>
  </li>
  <li>
    <p>Install-packages</p>
  </li>
</ul>

<p>To list all tags in the site playbook,</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook site.yml <span class="nt">--list-tags</span>
</code></pre></div></div>

<p>Similarly, playbooks may skip parts of the play with the use of the –skip-tags parameter. For example, in cases where the Docker images are built separately, a playbook that is provisioning a site may decide not to rebuild the images and instead pull them from a Docker registry.</p>

<p>The practice of tagging tasks is best done during the development of roles. This allows the developer to not only exercise the new roles but also test that tags work in isolation.</p>

<p>A recommended approach in developing playbooks is to start with the localdev inventory and promote the changes through each of the environments. The project is designed with roles, groups and host variable precedence to facilitate this development process.</p>

<p>The following environments have inventories configured (in order of promotion):</p>

<ul>
  <li>
    <p>localdev</p>
  </li>
  <li>
    <p>develop</p>
  </li>
  <li>
    <p>sit</p>
  </li>
  <li>
    <p>uat</p>
  </li>
  <li>
    <p>training</p>
  </li>
  <li>
    <p>staging</p>
  </li>
  <li>
    <p>production</p>
  </li>
</ul>

<p>The platform consists of servers and services. In order to provision the platform, the site playbook includes the following group playbooks that perform the actual provisioning:</p>

<ul>
  <li>
    <p>convoy.yml</p>

    <ul>
      <li>See <a href="#heading=h.yk5do8kzow0p">Convoy Volume Plugin</a></li>
    </ul>
  </li>
  <li>
    <p>server.yml</p>
  </li>
  <li>
    <p>applications.yml</p>
  </li>
  <li>
    <p>solr.yml</p>
  </li>
  <li>
    <p>author.yml</p>
  </li>
  <li>
    <p>publisher.yml</p>
  </li>
  <li>
    <p>processing.yml</p>
  </li>
  <li>
    <p>dispatcher.yml</p>
  </li>
  <li>
    <p>esb.yml</p>
  </li>
</ul>

<h4 id="site-teardownyml">site-teardown.yml</h4>

<p>Teardown playbook is for removing all applications and their data in a Docker host. Its purpose is to prepare the servers such that a new site can be provisioned without any dependencies on a previous state.</p>

<p>For example, it can be used to rebuild the develop environment on a daily basis and/or prepare the UAT environment before each test cycle.</p>

<p>Sample usage,</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook <span class="nt">-i</span> inventory/localdev site-teardown.yml <span class="nt">--user</span> aemdesign <span class="nt">--private-key</span> ../aemdesign-vm/keys/current/aemdesign
</code></pre></div></div>

<h4 id="site-devopsyml">site-devops.yml</h4>

<p>Deploys and configures the Management services.</p>

<h3 id="operations-playbooks">Operations Playbooks</h3>

<h4 id="operation-aem-deployyml">operation-aem-deploy.yml</h4>

<p>Installs versioned AEM content packages from a Maven repository to each of the authors, publishers and processing servers defined in the inventory.</p>

<h4 id="operation-esb-deployyml">operation-esb-deploy.yml</h4>

<p>Installs versioned ESB packages from a Maven repository to the Mulesoft ESB hot deploy folder <em>‘/opt/mule/apps’</em>.</p>

<h4 id="operation-oak-compactionyml">operation-oak-compaction.yml</h4>

<p>Operations playbook that implements the revision cleanup for the AEM Repository. Refer to the Adobe’s online documentation under ’*Maintaining the Repository *’for the significance of this operation:</p>

<p><a href="https://docs.adobe.com/docs/en/aem/6-3/deploy/platform/storage-elements-in-aem-6.html">https://docs.adobe.com/docs/en/aem/6-3/deploy/platform/storage-elements-in-aem-6.html</a></p>

<h4 id="operation-volume-fstrimyml">operation-volume-fstrim.yml</h4>

<p>Operations playbook to releasing unused blocks used by Convoy thinly provisioned volume. (refer to: <a href="#heading=h.ww4rafenb0y4">Thin Volume Management</a>).</p>

<h3 id="group-playbooks">Group Playbooks</h3>

<p>There are two group playbooks. Tasks that maintain the server and tasks that manages an application.</p>

<h4 id="server-playbooks">Server Playbooks</h4>

<table>
  <thead>
    <tr>
      <th>Playbook</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>server.yml</td>
      <td>Configures Red Hat Enterprise Linux servers. The following tasks are performed (role references in parenthesis),<br />Adding Network Interfaces before other roles requiring network connectivity ( server-network-interfaces).<br />Installation of RPMs using YUM<br />Installation of security updates<br />Installation of Python Packages required by Ansible (python-packages)<br />Configuration of the Docker service  (docker-host)<br />Configuration of Docker networks (docker-network)<br />Configuration of Server IPTables (server-iptables)</td>
    </tr>
    <tr>
      <td>applications.yml</td>
      <td>Configures common services for the Docker service and its containers.<br />Deploys Consul servers<br />Deploys Consul clients<br />Deploys a Registrator service for all Consul servers and clients</td>
    </tr>
    <tr>
      <td>convoy.yml</td>
      <td>Deploys and configures the Convoy Docker plugin.<br />Creates a data device in the rhel volume group<br />Creates a metadata device in the rhel volume group<br />Installs Convoy as a system service<br />Stats the Convoy system service</td>
    </tr>
  </tbody>
</table>

<h4 id="application-playbooks">Application Playbooks</h4>

<table>
  <thead>
    <tr>
      <th>Playbook</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>author.yml</td>
      <td>Automates the deployment and configuration of AEM authors.<br />Deploys AEM<br />Installs AEM Content Packages such as,<br />Feature Packs<br />Hotfixes<br />ACS Commons<br />3rd Party Content Packages<br />Configures Replication Agents<br />Configures Workflows</td>
    </tr>
    <tr>
      <td>publisher.yml</td>
      <td>Automates the deployment and configuration of AEM publishers.<br />Deploys AEM<br />Installs AEM Content Packages such as,<br />Feature Packs<br />Hotfixes<br />ACS Commons<br />3rd Party Content Packages</td>
    </tr>
    <tr>
      <td>dispatcher.yml</td>
      <td>Deploys and configures an author and publisher dispatcher.<br />Builds and configures the author and publisher dispatcher services Starts the services</td>
    </tr>
    <tr>
      <td>esb.yml</td>
      <td>Deploys and configures the ESB service</td>
    </tr>
    <tr>
      <td>processing.yml</td>
      <td>Automates the deployment and configuration of AEM processing.<br />Deploys AEM<br />Installs AEM Content Packages such as,<br />Feature Packs<br />Hotfixes<br />ACS Commons<br />3rd Party Content Packages</td>
    </tr>
    <tr>
      <td>solr.yml</td>
      <td>Deploys and configures Solr Cloud service</td>
    </tr>
  </tbody>
</table>

<h3 id="management-playbooks">Management Playbooks</h3>

<p>Deploys and configures management services in the AEM DAM Platform.  These are devops services such as,</p>

<ol>
  <li>
    <p>Jenkins</p>
  </li>
  <li>
    <p>Nexus</p>
  </li>
</ol>

<p>These are discussed in detail in the <a href="#heading=h.44alh5srvsoz">Development Tools</a> section.</p>

<h3 id="libraries">Libraries</h3>

<p>Ansible Modules adding AEM and Docker tasks to Playbooks.</p>

<p>Python source code for the modules can be found under the project location; <em>‘aemdesign-deploy/library/ansible-modules’</em>.</p>

<table>
  <thead>
    <tr>
      <th>Module</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>aem_bundles_wait_activated.py</td>
      <td>Polls AEM at ‘/system/console/bundles.json’ until ALL bundles are activated</td>
    </tr>
    <tr>
      <td>docker_containers.py</td>
      <td>Starts or stops ALL Docker containers on a server</td>
    </tr>
    <tr>
      <td>docker_images.py</td>
      <td>Removes ALL Docker images on a server</td>
    </tr>
    <tr>
      <td>docker_volumes.py</td>
      <td>Removes ALL Docker volumes on a server</td>
    </tr>
  </tbody>
</table>

<p>There are additional modules in the project. They are omitted as they are documented in <a href="https://github.com/Sensis/pyaem">https://github.com/wildone/pyaem</a>.</p>
:ET